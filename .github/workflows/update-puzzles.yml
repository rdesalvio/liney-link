name: Update Daily Puzzles

on:
  schedule:
    # Run daily at 2 AM UTC to ensure new puzzle is ready
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  update-puzzles:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Download player data from release
      run: |
        echo "ðŸ“¥ Downloading player data from GitHub releases..."

        # Download players.tar.gz from latest release
        if gh release download latest --pattern "players.tar.gz" --dir . 2>/dev/null; then
          echo "âœ… Downloaded players.tar.gz"
          tar -xzf players.tar.gz
          rm players.tar.gz
          echo "ðŸ“¦ Extracted players/ folder"
        else
          echo "âš ï¸  No players.tar.gz in release 'latest'"
          echo ""
          echo "ERROR: Cannot generate puzzles without player data!"
          echo ""
          echo "Please create an initial data release first:"
          echo "1. Go to Actions â†’ Update Player Data Cache"
          echo "2. Click 'Run workflow'"
          echo "3. Wait for it to complete"
          echo "4. Then retry this workflow"
          echo ""
          echo "Or run locally: ./create_data_release.sh"
          exit 1
        fi

        # Download player_linkages.tar.gz from latest release
        if gh release download latest --pattern "player_linkages.tar.gz" --dir . 2>/dev/null; then
          echo "âœ… Downloaded player_linkages.tar.gz"
          tar -xzf player_linkages.tar.gz
          rm player_linkages.tar.gz
          echo "ðŸ“¦ Extracted player_linkages/ folder"
        else
          echo "âš ï¸  No player_linkages.tar.gz in release 'latest'"
          echo ""
          echo "ERROR: Cannot generate puzzles without linkage data!"
          echo ""
          echo "Please create an initial data release first:"
          echo "1. Go to Actions â†’ Update Player Data Cache"
          echo "2. Click 'Run workflow'"
          echo "3. Wait for it to complete"
          echo "4. Then retry this workflow"
          echo ""
          echo "Or run locally: ./create_data_release.sh"
          exit 1
        fi

        echo ""
        echo "âœ… Player data ready"
        echo "   Players: $(find players -name '*.json' | wc -l) files"
        echo "   Linkages: $(find player_linkages -name '*.json' -not -name 'summary.json' | wc -l) files"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Generate new puzzles
      run: |
        # Generate puzzles for next 30 days to ensure we're always ahead
        python3 generate_monthly_puzzles.py
        
    - name: Check for changes
      id: changes
      run: |
        git diff --quiet docs/puzzles/ || echo "changes=true" >> $GITHUB_OUTPUT
        
    - name: Commit and push changes
      if: steps.changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add docs/puzzles/
        git add docs/puzzle_index.json
        git commit -m "ðŸŽ¯ Add new daily puzzles - $(date +'%Y-%m-%d')"
        git push